(function(){var flipbook,listWrap,listWrapUl,listWrapUlWidth,albmuLi,listContentFn,subMenuWrap,subMenuWrapLi,subMenu,isSourceLoaded=false,isMagzineInited=false,menu,prev,next,close,n=0,length,ceil,isGalleryNow=false,_galleryPage=null,$gallery,$viewer,$mr,loadingUrl="../static/images/loader.gif",_oTitle=document.title,_isOpen=false;function initVar(){listWrap=$(".list-wrap"),flipbook=$("#magazine_ctn"),listContentFn=doT.template($("#list-content").html()),subMenuWrap=$(".sub-menu-wrap"),subMenu=doT.template($("#sub-menu").html()),menu=$(".menu"),prev=$(".prev"),next=$(".next"),$gallery=$("#max_viewer"),$viewer=$gallery.children(".img_viewer"),$mr=$(".magazine-radius")}function isEven(num){return num%2==0?true:false}function makeDataEven(list){if(!isEven(list.length)){list.push(list[list.length-1])}}function setAlbumStyle(data){if(data.data&&data.data.length<4){next.hide()}else{next.show()}}function getAlbum(param){$.ajax({url:"http://120.24.220.14/b612/index.php?r=site/sets",type:"get",data:param}).success(function(data){var datas=JSON.parse(data);if(datas.status=="success"){setAlbumStyle(datas);listWrap.html(listContentFn(datas.data));albmuLi=listWrap.find("ul li");listWrapUl=listWrap.find("ul");listWrapUlWidth=listWrap.width();length=datas.data.length;ceil=Math.ceil(length/4);listWrapUl.width(listWrapUlWidth*ceil+100);albmuLi.click(function(){var albumid=$(this).attr("album-id");var albumName=$(this).attr("album-name");setTitle(albumName);Hash.go("album/"+albumid+"/page/2").update();initApp(albumid,albumName)})}})}function subMenuInit(){close.click(function(){subMenuWrap.removeClass("show")});subMenuWrapLi.click(function(){var $li=$(this);var $lis=$li.parent("ul").find("li");var param=$li.attr("groupid");$lis.removeClass("active");$li.addClass("active");getAlbum(param);n=0;subMenuWrap.removeClass("show")})}function getMenu(){$.ajax({url:"http://120.24.220.14/b612/index.php?r=site/groups",type:"get",data:null}).success(function(data){var datas=JSON.parse(data);if(datas.status=="success"){subMenuWrap.html(subMenu(datas.data));close=subMenuWrap.find(".close");subMenuWrapLi=subMenuWrap.find("li");subMenuWrapLi.eq(0).addClass("active");subMenuInit()}})}function closeFlipbook(event){$("#canvas").fadeOut(300,function(){resetFlipBook()});if(flipbook.turn("is")){flipbook.turn("destroy");flipbook.data("booklist",null);_isOpen=false}Hash.go("");document.title=_oTitle}function initEvents(){initGallery();$(".open-close").click(closeFlipbook);menu.click(function(){subMenuWrap.addClass("show")});next.click(function(){n++;if(n>=ceil-1){$(this).hide()}if(n>=ceil){n=ceil-1}prev.show();listWrapUl.stop().animate({marginLeft:-n*listWrapUlWidth+"px"},500)});prev.click(function(){n--;if(n<=0){n=0;$(this).hide()}next.show();listWrapUl.stop().animate({marginLeft:-n*listWrapUlWidth+"px"},500)});$("body").on("click",".cloned_share_panel .weibo_btn",function(evt){var $lWrap=$(this).parents(".l-img-wrap");var $img=$lWrap.find("> .img-wrap > img");var descTxt=$lWrap.find(".desc").html().trim();shareWeibo($img,descTxt)}).on("click",".cloned_share_panel .wechat_btn",function(evt){shareWechat()})}function initApp(albumId){$.ajax({url:"http://120.24.220.14/b612/index.php?r=site/set",type:"get",data:{"id":albumId}}).success(function(data){var DATA=JSON.parse(data);DATA.albumId=albumId;$("#canvas").fadeIn(300);if(isSourceLoaded==true){return loadApp(DATA)}else{yepnope({test:Modernizr.csstransforms,yep:["../static/scripts/lib/turn.js"],nope:["../static/scripts/lib/turn.html4.min.js"],both:["../static/styles/css/jquery.ui.css"],complete:function(){isSourceLoaded=true;loadApp(DATA)}})}})}function initGallery(){$("#magazine_ctn").on("click",".img-wrap > img",function(evt){evt.preventDefault();var $img=$(this);var imgUrl=$img.attr("src");var curPage=parseInt($img.parents(".page-wrapper").attr("page"));if(curPage==1||curPage==flipbook.turn("pages")){return}openGallery(imgUrl,null,null,curPage);return false});$gallery.on("click",function(evt){hideGallery()})}function openGallery(imgUrl,text,gallery_styles,curPage){isGalleryNow=true;if(curPage){_galleryPage=curPage}$viewer.css({"background-image":"url("+imgUrl+")"});text?$viewer.html(text):"";gallery_styles?$viewer.css(gallery_styles):"";$gallery.removeClass("hide")}function hideGallery(){$gallery.addClass("hide");isGalleryNow=false;$viewer.html("");$viewer.css({"background-image":"url("+loadingUrl+")","background-position":"center","background-size":"contain"});_galleryPage=null}function nextGallery(isPrev){var _pages=flipbook.turn("pages");if(!_galleryPage||!isPrev?_galleryPage>=(_pages-1):_galleryPage<=2){return false}var nextPage=!isPrev?++_galleryPage:--_galleryPage;var booklist=flipbook.data("booklist");var nextSrc=booklist[nextPage-1]["url"];openGallery(nextSrc)}function shareWeibo($img,desc){var imgUrl=$img.attr("src");(function(s,d,e,r,l,p,t,z,c){var f="http://v.t.sina.com.cn/share/share.php?appkey=真实的appkey",u=z||d.location,p=["&url=",e(u),"&title=",e(t||d.title),"&source=",e(r),"&sourceUrl=",e(l),"&content=",c||"gb2312","&pic=",e(p||"")].join("");
function a(){if(!window.open([f,p].join(""),"mb",["toolbar=0,status=0,resizable=1,width=440,height=430,left=",(s.width-440)/2,",top=",(s.height-430)/2].join(""))){u.href=[f,p].join("")}}if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent,"","",imgUrl,desc,location.href,"utf-8")}function shareWechat(){var imgUrl=genQRCode(document.URL);var text="微信扫一扫，轻松分享";openGallery(imgUrl,text,{"background-position":"center 150px","background-size":"180px"})}function genQRCode(url){var _p=encodeURIComponent(url);var s="http://tool.oschina.net/action/qrcode/generate?data="+_p+"%0D%0A&output=image%2Fgif&error=L&type=0&margin=10&size=4";return s}function resetFlipBook(){flipbook.addClass("border")}var needCheck=true;function checkSpecialPage(){if(!needCheck){return}var pages=flipbook.turn("pages");var $last=$(".page.p"+pages);if($last.length){$last.addClass("special_page");needCheck=false}}var _onceDict={},_oncePoint=1;function once(fn){fn._onceId=_oncePoint++;return function(a,b,c,d){if(_onceDict[fn._onceId]){}else{fn(a,b,c,d);_onceDict[fn._onceId]=true}}}var onceD=once(function(i_page,_pages,album_id){disableControls(i_page);$('.page-wrapper[page="'+_pages+'"] .p'+_pages).addClass("special_page");album_id?setTitle(album_id):""});function getSeries(){var $c=$(".sub-menu-wrap li.active");return $c.html().trim()||"B612"}function setTitle(album){var seriesName=getSeries();document.title=seriesName+"-"+album}function loadApp(data){var album_id=data.albumId;if(_isOpen){return"Only One Book Can be opend"}$("#canvas").fadeIn(300);if(flipbook.width()==0||flipbook.height()==0){setTimeout(function(){loadApp(data)},20);return}makeDataEven(data.data);flipbook.data("booklist",data.data);var initalizePage=Hash.read("page")||2;var magazineW=960;var magazineH=560;$mr.css({"width":magazineW,"height":magazineH});var _pages=data.data.length;_isOpen=true;flipbook.turn({acceleration:!isChrome(),width:magazineW,page:initalizePage,height:magazineH,duration:1000,autoCenter:true,elevation:50,pages:_pages,when:{turning:function(event,page,view){var book=$(this),currentPage=book.turn("page"),pages=book.turn("pages");var albumId=Hash.read("album");Hash.go("album/"+albumId+"/page/"+page).update();disableControls(page)},start:function(e,pageObj){},turned:function(event,page,view){disableControls(page);var _pages=flipbook.turn("pages");$(this).turn("center");$("#slider").slider("value",getViewNumber($(this),page));if(page==1){$(this).turn("peel","br")}else{if(page==_pages){$(this).turn("peel","bl")}else{}}checkSpecialPage()},missing:function(event,pages){for(var i=0;i<pages.length;i++){addPage(pages[i],$(this),data)}}}});onceD(initalizePage,_pages,album_id);resizeViewport();$mr.css({opacity:1});initMagazineEvents();$("#slider").slider({min:1,max:numberOfViews(flipbook),start:function(event,ui){if(!window._thumbPreview){window._thumbPreview=$("<div />",{"class":"thumbnail"}).html("<div></div>");setPreview(ui.value);_thumbPreview.appendTo($(ui.handle))}else{setPreview(ui.value)}moveBar(false)},slide:function(event,ui){setPreview(ui.value)},stop:function(){if(window._thumbPreview){_thumbPreview.removeClass("show")}$(".magazine").turn("page",Math.max(1,$(this).slider("value")*2-2))}});$(".magazine").addClass("animated")}function initMagazineEvents(){if(isMagzineInited){return false}$(document).keydown(function(e){var previous=37,next=39,esc=27;var _isFlip=$(".magazine").turn("is");switch(e.keyCode){case previous:!isGalleryNow?(_isFlip?$(".magazine").turn("previous"):""):nextGallery(true);e.preventDefault();break;case next:!isGalleryNow?(_isFlip?$(".magazine").turn("next"):""):nextGallery();e.preventDefault();break;case esc:isGalleryNow?hideGallery():closeFlipbook();e.preventDefault();break}});$(window).resize(function(evt){resizeViewport(evt)}).bind("orientationchange",function(evt){resizeViewport(evt)});$(".next-button").bind($.mouseEvents.over,function(){$(this).addClass("next-button-hover")}).bind($.mouseEvents.out,function(){$(this).removeClass("next-button-hover")}).bind($.mouseEvents.down,function(){$(this).addClass("next-button-down")}).bind($.mouseEvents.up,function(){$(this).removeClass("next-button-down")}).click(function(){$(".magazine").turn("next")});$(".previous-button").bind($.mouseEvents.over,function(){$(this).addClass("previous-button-hover")}).bind($.mouseEvents.out,function(){$(this).removeClass("previous-button-hover")}).bind($.mouseEvents.down,function(){$(this).addClass("previous-button-down")}).bind($.mouseEvents.up,function(){$(this).removeClass("previous-button-down")}).click(function(){$(".magazine").turn("previous")});isMagzineInited=true}function initSite(){initVar();getMenu();getAlbum(null);initEvents();var hashData=Hash.hashParam();if(hashData.album){initApp(hashData.album)}}$(function(){initSite()})})();